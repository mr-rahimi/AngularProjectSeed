import { Injectable } from '@angular/core';
import { Observable, BehaviorSubject } from 'rxjs';
import { PagingOptions } from '../shared/models/common/pagingOptions';
import { SimpleSearchModel } from '../shared/models/common/simple-search-model';
import { PagedSortedList } from '../shared/models/common/sortedList';
import { share } from 'rxjs/operators';
import { ObservableState, recordState } from '../shared/helpers';
import { {{pascalCase entity.name}}Service } from '../shared/services';
import { {{pascalCase entity.name}}, {{pascalCase entity.name}}DetailsModel, {{pascalCase entity.name}}CreateModel,{{pascalCase entity.name}}EditModel } from '../shared/models/{{camelCase entity.name}}';

@Injectable({ providedIn: 'root' })
export class {{pascalCase entity.name}}ModuleService {
  constructor(private {{camelCase entity.name}}Service: {{pascalCase entity.name}}Service) {
  }
  pagingOptions: PagingOptions = { pageIndex: 0, pageSize: 5 };
  simpleSearchModel: SimpleSearchModel = {};
  simpleSearch = true;
  public searchState: ObservableState = new ObservableState();
  public currentPage: PagedSortedList<Book> = {
    items: [],
    pageIndex: 0,
    pageSize: 5,
    sortingOptions: [],
    totalItemsCount: 0
  };
  private _pageObservable: BehaviorSubject<PagedSortedList<{{pascalCase entity.name}}>> = new BehaviorSubject<PagedSortedList<{{pascalCase entity.name}}>>(this.currentPage);
  private _stateObservable: BehaviorSubject<ObservableState> = new BehaviorSubject<ObservableState>(this.searchState);

  refresh() {
    if (this.simpleSearch) {
      this.simpleSerach();
    }
  }
  private simpleSerach() {
    const x = { ...this.simpleSearchModel, ...this.pagingOptions };
    this.searchState.Wait();
    this.{{camelCase entity.name}}Service.{{camelCase entity.name}}SimpleSearch(x)
      .pipe(
        share(),
        recordState(this.searchState)
      )
      .subscribe(x => {
        this.currentPage = x
        this._pageObservable.next(x);
      });
  }

  get page(): Observable<PagedSortedList<{{pascalCase entity.name}}>> {
    return this._pageObservable;
  }
  get state(): Observable<ObservableState> {
    return this._stateObservable;
  }
}
